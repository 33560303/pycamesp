<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>lib.motion.motion API documentation</title>
<meta name="description" content="Motion detection only work with ESP32CAM (Requires specially modified ESP32CAM firmware to handle motion detection.)" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>lib.motion.motion</code></h1>
</header>
<section id="section-intro">
<p>Motion detection only work with ESP32CAM (Requires specially modified ESP32CAM firmware to handle motion detection.)</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># Distributed under MIT License
# Copyright (c) 2021 Remi BERTHOLET
&#34;&#34;&#34; Motion detection only work with ESP32CAM (Requires specially modified ESP32CAM firmware to handle motion detection.) &#34;&#34;&#34;
import sys
import machine
import uos
try:
        import camera
except:
        pass
import uasyncio
import video
import time
from tools import useful
from tools import jsonconfig
import server
from motion import presence

class MotionConfig:
        &#34;&#34;&#34; Configuration class of motion detection &#34;&#34;&#34;
        def __init__(self):
                # Indicates if the motion is activated
                self.activated = False

                # Suspend the motion detection when presence detected
                self.suspendOnPresence = True

                # Minimum threshold detection for saturation
                self.saturationDetection=10
  
                # Minimum threshold detection for light
                self.lightDetection=10

                # Awake time on battery (seconds)
                self.awakeTime = 120

                # Error range ignore light modification
                self.lightErrorRange=5

                # Error range ignore saturation modification
                self.saturationErrorRange=5
  
                # Max images in motion historic
                self.maxMotionImages=10

                # Glitch threshold of image ignored (sometime the camera bug)
                self.thresholdGlitch=2

                # Threshold of minimum image to detect motion
                self.thresholdMotion=3

                # Number of images before camera stabilization
                self.stabilizationCamera=6

        def save(self, file = None):
                &#34;&#34;&#34; Save configuration &#34;&#34;&#34;
                result = jsonconfig.save(self, file)
                return result

        def update(self, params):
                &#34;&#34;&#34; Update configuration &#34;&#34;&#34;
                result = jsonconfig.update(self, params)
                return result

        def load(self, file = None):
                &#34;&#34;&#34; Load configuration &#34;&#34;&#34;
                result = jsonconfig.load(self, file)
                return result

class ImageMotion:
        &#34;&#34;&#34; Class managing a motion detection image &#34;&#34;&#34;
        baseIndex = [0]
        motionBaseId = [0]
        def __init__(self, motion, config):
                self.motion = motion
                self.baseIndex[0] += 1
                self.index    = self.baseIndex[0]
                self.filename = None
                self.diffSaturation = 0
                self.diffLight = 0
                self.diffHue  = 0
                self.notified = False
                self.motionId = None
                self.date     = useful.dateToFilename()
                self.path     = useful.dateToFilename()[:-3]+&#34;-00&#34;
                self.motionDetected = False
                self.config = config

        def deinit(self):
                &#34;&#34;&#34; Destructor &#34;&#34;&#34;
                self.motion.deinit()
        
        def setMotionId(self, motionId = None):
                &#34;&#34;&#34; Set the unique image identifier &#34;&#34;&#34;
                if motionId == None:
                        self.motionBaseId[0] += 1
                        self.motionId = self.motionBaseId[0]
                else:
                        if self.motionId == None:
                                self.motionId = motionId
                        else:
                                print(&#34;Motion id already set&#34;)
        
        def getMotionId(self):
                &#34;&#34;&#34; Get the unique image identifier &#34;&#34;&#34;
                return self.motionId

        def getFilename(self):
                &#34;&#34;&#34; Get the storage filename &#34;&#34;&#34;
                return &#34;%s id=%d S=%d L=%d.jpg&#34;%(self.date, self.index, self.diffSaturation, self.diffLight)

        def save(self):
                &#34;&#34;&#34; Save the image on sd card &#34;&#34;&#34;
                if useful.SdCard.isMounted():
                        useful.makedir(useful.SdCard.getMountpoint() + &#34;/&#34; + self.path, True)
                        useful.SdCard.save(self.path + &#34;/&#34; + self.getFilename(), self.motion.getImage())

        def compare(self, previous, set=False):
                &#34;&#34;&#34; Compare two motion images to get differences &#34;&#34;&#34;
                self.motion.setErrorLight(self.config.lightErrorRange)
                self.motion.setErrorSaturation(self.config.saturationErrorRange)
                res = self.motion.compare(previous.motion)
                if set:
                        self.diffHue, self.diffSaturation, self.diffLight  = res[0],res[1],res[2]
                return (res[0],res[1],res[2])

        def getMotionDetected(self):
                &#34;&#34;&#34; Get the motion detection status &#34;&#34;&#34;
                return self.motionDetected
        
        def setMotionDetected(self):
                &#34;&#34;&#34; Set the motion detection status &#34;&#34;&#34;
                self.motionDetected = True
        
        def get(self):
                &#34;&#34;&#34; Get the image captured &#34;&#34;&#34;
                return self.motion.getImage()
        
        def getDiffHue(self):
                &#34;&#34;&#34; Get the hue difference &#34;&#34;&#34;
                return self.diffHue

        def getDiffSaturation(self):
                &#34;&#34;&#34; Get the saturation difference &#34;&#34;&#34;
                return self.diffSaturation

        def getDiffLight(self):
                &#34;&#34;&#34; Get the light difference &#34;&#34;&#34;
                return self.diffLight

        def getFeature(self):
                &#34;&#34;&#34; Return mean, min, max light, mean, min, max, saturation, total count &#34;&#34;&#34;
                return self.motion.getFeature()

        def resetDifferences(self):
                &#34;&#34;&#34; Reset the differences, used during the camera stabilization image &#34;&#34;&#34;
                self.diffSaturation = 0
                self.diffLight = 0

class Motion:
        &#34;&#34;&#34; Class to manage the motion capture &#34;&#34;&#34;
        def __init__(self, config= None, onBattery=False, pirDetection=False):
                self.images = []
                self.index  = 0
                self.config = config
                self.onBattery = onBattery
                self.pirDetection = pirDetection

        def open(self):
                &#34;&#34;&#34; Open camera &#34;&#34;&#34;
                print(&#34;Open camera&#34;)
                video.Camera.open()
                self.resume()

        def resume(self):
                &#34;&#34;&#34; Resume the camera, restore the camera configuration after an interruption &#34;&#34;&#34;
                # video.Camera.framesize(b&#34;UXGA&#34;) # 1600x1200
                # video.Camera.framesize(b&#34;SXGA&#34;) # 1280x1024
                # video.Camera.framesize(b&#34;XGA&#34;)  # 1024x768
                video.Camera.framesize(b&#34;SVGA&#34;) # 800x600

                video.Camera.pixformat(b&#34;JPEG&#34;)
                video.Camera.quality(10)
                video.Camera.brightness(0)
                video.Camera.contrast(0)
                video.Camera.saturation(0)
                video.Camera.hmirror(0)
                video.Camera.vflip(0)

        def capture(self):
                &#34;&#34;&#34; Capture motion image &#34;&#34;&#34;
                result = None
                retry = 10
                if len(self.images) &gt;= self.config.maxMotionImages:
                        image = self.images.pop()
                        
                        # If motion detected on image, on battery the first five images are sent
                        if image.getMotionDetected() or (self.onBattery and self.pirDetection and image.index &lt;= 3):
                                # Notification of motion
                                result = (&#34;Intrusion %s&#34;%image.getFilename(), image)

                                # Save image to sdcard
                                image.save()
                        else:
                                image.deinit()
                while 1:
                        if retry == 0:
                                print(&#34;Reset&#34;)
                                machine.reset()

                        try:
                                image = ImageMotion(video.Camera.motion(), self.config)
                                self.images.insert(0, image)
                                self.index += 1
                                break
                        except ValueError:
                                print(&#34;Failed to get motion %d try before reset&#34;%retry)
                                retry += 1
                                time.sleep(0.5)
                return result

        def isStabilized(self):
                &#34;&#34;&#34; Indicates if the camera is stabilized &#34;&#34;&#34;
                # If the PIR detection force the stabilization
                if self.pirDetection == True:
                        stabilized = True
                # If the camera not stabilized
                elif len(self.images) &lt; self.config.stabilizationCamera:
                        stabilized = False
                else:
                        stabilized = True
                return stabilized

        def compare(self):
                &#34;&#34;&#34; Compare all images captured and search differences &#34;&#34;&#34;
                differences = {}
                if len(self.images) &gt;= 2:
                        current = self.images[0]
                        
                        # Compute the motion identifier
                        for previous in self.images[1:]:
                                hue, saturation, light = current.compare(previous, True)

                                # If camera not stabilized
                                if self.isStabilized() == False:
                                        # Reject the differences
                                        current.resetDifferences()
                                        break
                                # If image seem equal to previous
                                if saturation &lt;= self.config.saturationDetection and \
                                   light      &lt;= self.config.lightDetection:
                                        # Reuse the motion identifier
                                        current.setMotionId(previous.motionId)
                                        break
                        else:
                                # Create new motion id
                                current.setMotionId()

                        # Compute the list of differences
                        diffs = &#34;&#34;
                        for image in self.images:
                                differences.setdefault(image.getMotionId(), []).append(image.getMotionId())
                                if image.getMotionId() != None:
                                        diffs += &#34; %d:%d,%d&#34;%(image.getMotionId(), image.getDiffSaturation(), image.getDiffLight())
                        sys.stdout.write(&#34;\r%s %s    &#34;%(useful.dateToString()[12:], diffs))
                return differences

        def detect(self):
                &#34;&#34;&#34; Detect motion &#34;&#34;&#34;
                detected = False
                changePolling = False

                # Compute the list of differences
                differences = self.compare()

                # Too many differences found
                if len(list(differences.keys())) &gt;= self.config.thresholdMotion:
                        detected = True
                        changePolling = True
                # If no differences
                elif len(list(differences.keys())) == 1:
                        detected = False
                # If not enough differences
                elif len(list(differences.keys())) &lt;= self.config.thresholdGlitch:
                        detected = True
                        changePolling = True
                        # Check if it is a glitch
                        for diff in differences.values():
                                if len(diff) &lt;= 1:
                                        print(&#34;%s Glitch (S=%d,L=%d)    &#34;%(useful.dateToString()[12:], self.images[0].getDiffSaturation(), self.images[0].getDiffLight()))
                                        # Glitch ignored
                                        detected = False
                                        break
                # Not detected
                else:
                        detected = False

                if detected:
                        # Mark all motion images
                        for image in self.images:
                                diffSaturation = image.getDiffSaturation()
                                diffLight      = image.getDiffLight()
                                
                                # If image seem equal to previous
                                if  diffSaturation &gt; self.config.saturationDetection and \
                                    diffLight      &gt; self.config.lightDetection:
                                        image.setMotionDetected()
                return detected, changePolling

async def sleep_ms(duration):
        &#34;&#34;&#34; Multiplatform sleep_ms &#34;&#34;&#34;
        await uasyncio.sleep_ms(duration)

def getOlderDirectories(mountpoint, quantity=10):
        &#34;&#34;&#34; Get the list of older directories &#34;&#34;&#34;
        older = []
        # Parse all directories in sdcard
        for fileinfo in uos.ilistdir(useful.SdCard.getMountpoint()):
                filename = fileinfo[0]
                typ = fileinfo[1]
                # If directory found
                if typ &amp; 0xF000 == 0x4000:
                        # If motion directory recognized
                        if  (filename[4] == &#34;-&#34; and filename[7] == &#34;-&#34; and len(filename) == 10) or \
                                (filename[4] == &#34;-&#34; and filename[7] == &#34;-&#34; and (filename[10] == &#34;_&#34; or filename[10] == &#34; &#34;) and filename[13] == &#34;-&#34; and (len(filename) == 16 or len(filename) == 19)):
                                # Add directory to the list
                                older.append(filename)
                                if len(older) &gt; (quantity + 10):
                                        older.sort()
                                        older = older[:quantity]
        older.sort()
        older = older[:quantity]
        return older

def removeFiles(directory, simulate=False):
        &#34;&#34;&#34; Remove all files in the directory &#34;&#34;&#34;
        import shell
        notEmpty = False
        # Parse all directories in sdcard
        for fileinfo in uos.ilistdir(directory):
                filename = fileinfo[0]
                typ      = fileinfo[1]
                # If file found
                if typ &amp; 0xF000 != 0x4000:
                        shell.rmfile(directory + &#34;/&#34; + filename, simulate=simulate)
                else:
                        removeFiles(directory + &#34;/&#34; + filename)
                        notEmpty = True
        
        if notEmpty:
                shell.rm(directory, recursive=True, simulate=simulate)
        else:
                shell.rmdir(directory, recursive=True, simulate=simulate)

async def removeOlder():
        &#34;&#34;&#34; Remove older files to make space &#34;&#34;&#34;
        while 1:
                await sleep_ms(100000)
                await server.waitResume()
                if useful.SdCard.isMounted():
                        # If not enough space available on sdcard
                        if useful.SdCard.getFreeSize() * 10000// useful.SdCard.getMaxSize() &lt;= 5:
                                olders = getOlderDirectories(useful.SdCard.getMountpoint())
                                for directory in olders:
                                        removeFiles(useful.SdCard.getMountpoint()+ &#34;/&#34;+ directory)

async def detectMotion(onBattery, pirDetection):
        &#34;&#34;&#34; Asynchronous motion detection main routine &#34;&#34;&#34;
        from server   import notifyMessage
        from motion   import MotionConfig
        import wifi

        # Open motion configuration
        motionConfig      = MotionConfig()
        if motionConfig.load() == False:
                motionConfig.save()

        motion = None
        pollingCounter = 0
        previousReserved = None
        pollingFrequency = 200
        batteryLevel = -2
        if onBattery:
                if pirDetection == True:
                        pollingFrequency = 3
                motionConfig.load()
                wifiOn = False
                startTime = time.time()
        else:
                wifiOn = True
        detection = None

        previousActivated = None
        while True:
                await server.waitResume()
  
                # If detection
                if detection != None:
                        message, image = detection
                        # Release image buffer
                        image.deinit()

                if motionConfig.activated:
                        activated = False
                        if motionConfig.suspendOnPresence:
                                if presence.isPresenceDetected() == False:
                                        activated = True
                        else:
                                activated = True
                else:
                        activated = False

                if previousActivated != activated:
                        await notifyMessage(b&#34;Motion detection %s&#34; %(b&#34;activated&#34; if activated else b&#34;stopped&#34;))
                        previousActivated = activated

                # If the motion activated
                if activated:
                        # If motion not initialized
                        if motion == None:
                                # The sdcard not available on battery
                                if onBattery != True:
                                        useful.SdCard.mount()
                                motion = Motion(motionConfig, onBattery, pirDetection)
                                motion.open()

                        # If camera available to detect motion
                        if video.Camera.isReserved() == False:
                                # If the camera previously reserved
                                if previousReserved == True:
                                        # Restore camera motion configuration
                                        previousReserved = False
                                        motion.resume()
                                try:
                                        # If camera not stabilized speed start
                                        if motion.isStabilized() == True:
                                                await sleep_ms(pollingFrequency)

                                        # If camera available to detect motion
                                        if video.Camera.isReserved() == False:
                                                # Capture motion image
                                                detection = motion.capture()

                                                # If camera not stabilized speed start
                                                if motion.isStabilized() == True:
                                                        await sleep_ms(pollingFrequency)

                                        # If camera available to detect motion
                                        if video.Camera.isReserved() == False:
                                                # If motion detected
                                                if detection != None:
                                                        # Notify motion with push over
                                                        message, image = detection
                                                        # On battery the wifi start after taking pictures
                                                        if wifiOn == False:
                                                                from server import start
                                                                from tools import Battery
                                                                start(withoutServer=True)
                                                                wifiOn = True
                                                                batteryLevel = Battery.getLevel()
                                                        if batteryLevel &gt;= 0:
                                                                message = message [:-4] + &#34; Bat %s %%&#34;%batteryLevel
                                                        await notifyMessage(message, image.get())
                                                # Detect motion
                                                detected, changePolling = motion.detect()

                                                # If motion found
                                                if changePolling == True:
                                                        # Speed up the polling frequency
                                                        pollingFrequency = 15
                                                        startTime = time.time()
                                                else:
                                                        # Slow down the polling frequency
                                                        pollingFrequency = 200
                                except Exception as err:
                                        print(useful.exception(err))
                        else:
                                # Camera buzy, motion capture suspended
                                previousReserved = True
                                await notifyMessage(b&#34;Streaming video suspend motion detection&#34;)
                                await sleep_ms(30000)
                else:
                        # Motion capture disabled
                        await sleep_ms(500)
                pollingCounter += 1

                # Reload configuration each 3 s
                if pollingCounter % 5 == 0:
                        motionConfig.load()

                # If the battery mode activated
                if onBattery:
                        # If the motion detection activated
                        if motionConfig.activated:
                                # Wait duration after the last detection
                                if time.time() &gt; startTime + motionConfig.awakeTime:
                                        import machine
                                        print(&#34;&#34;)
                                        print(&#34;####################################&#34;)
                                        print(&#34;# DEEP SLEEP TO WAIT PIR DETECTION #&#34;)
                                        print(&#34;####################################&#34;)
                                        machine.deepsleep(10000)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="lib.motion.motion.detectMotion"><code class="name flex">
<span>async def <span class="ident">detectMotion</span></span>(<span>onBattery, pirDetection)</span>
</code></dt>
<dd>
<div class="desc"><p>Asynchronous motion detection main routine</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def detectMotion(onBattery, pirDetection):
        &#34;&#34;&#34; Asynchronous motion detection main routine &#34;&#34;&#34;
        from server   import notifyMessage
        from motion   import MotionConfig
        import wifi

        # Open motion configuration
        motionConfig      = MotionConfig()
        if motionConfig.load() == False:
                motionConfig.save()

        motion = None
        pollingCounter = 0
        previousReserved = None
        pollingFrequency = 200
        batteryLevel = -2
        if onBattery:
                if pirDetection == True:
                        pollingFrequency = 3
                motionConfig.load()
                wifiOn = False
                startTime = time.time()
        else:
                wifiOn = True
        detection = None

        previousActivated = None
        while True:
                await server.waitResume()
  
                # If detection
                if detection != None:
                        message, image = detection
                        # Release image buffer
                        image.deinit()

                if motionConfig.activated:
                        activated = False
                        if motionConfig.suspendOnPresence:
                                if presence.isPresenceDetected() == False:
                                        activated = True
                        else:
                                activated = True
                else:
                        activated = False

                if previousActivated != activated:
                        await notifyMessage(b&#34;Motion detection %s&#34; %(b&#34;activated&#34; if activated else b&#34;stopped&#34;))
                        previousActivated = activated

                # If the motion activated
                if activated:
                        # If motion not initialized
                        if motion == None:
                                # The sdcard not available on battery
                                if onBattery != True:
                                        useful.SdCard.mount()
                                motion = Motion(motionConfig, onBattery, pirDetection)
                                motion.open()

                        # If camera available to detect motion
                        if video.Camera.isReserved() == False:
                                # If the camera previously reserved
                                if previousReserved == True:
                                        # Restore camera motion configuration
                                        previousReserved = False
                                        motion.resume()
                                try:
                                        # If camera not stabilized speed start
                                        if motion.isStabilized() == True:
                                                await sleep_ms(pollingFrequency)

                                        # If camera available to detect motion
                                        if video.Camera.isReserved() == False:
                                                # Capture motion image
                                                detection = motion.capture()

                                                # If camera not stabilized speed start
                                                if motion.isStabilized() == True:
                                                        await sleep_ms(pollingFrequency)

                                        # If camera available to detect motion
                                        if video.Camera.isReserved() == False:
                                                # If motion detected
                                                if detection != None:
                                                        # Notify motion with push over
                                                        message, image = detection
                                                        # On battery the wifi start after taking pictures
                                                        if wifiOn == False:
                                                                from server import start
                                                                from tools import Battery
                                                                start(withoutServer=True)
                                                                wifiOn = True
                                                                batteryLevel = Battery.getLevel()
                                                        if batteryLevel &gt;= 0:
                                                                message = message [:-4] + &#34; Bat %s %%&#34;%batteryLevel
                                                        await notifyMessage(message, image.get())
                                                # Detect motion
                                                detected, changePolling = motion.detect()

                                                # If motion found
                                                if changePolling == True:
                                                        # Speed up the polling frequency
                                                        pollingFrequency = 15
                                                        startTime = time.time()
                                                else:
                                                        # Slow down the polling frequency
                                                        pollingFrequency = 200
                                except Exception as err:
                                        print(useful.exception(err))
                        else:
                                # Camera buzy, motion capture suspended
                                previousReserved = True
                                await notifyMessage(b&#34;Streaming video suspend motion detection&#34;)
                                await sleep_ms(30000)
                else:
                        # Motion capture disabled
                        await sleep_ms(500)
                pollingCounter += 1

                # Reload configuration each 3 s
                if pollingCounter % 5 == 0:
                        motionConfig.load()

                # If the battery mode activated
                if onBattery:
                        # If the motion detection activated
                        if motionConfig.activated:
                                # Wait duration after the last detection
                                if time.time() &gt; startTime + motionConfig.awakeTime:
                                        import machine
                                        print(&#34;&#34;)
                                        print(&#34;####################################&#34;)
                                        print(&#34;# DEEP SLEEP TO WAIT PIR DETECTION #&#34;)
                                        print(&#34;####################################&#34;)
                                        machine.deepsleep(10000)</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.getOlderDirectories"><code class="name flex">
<span>def <span class="ident">getOlderDirectories</span></span>(<span>mountpoint, quantity=10)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the list of older directories</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getOlderDirectories(mountpoint, quantity=10):
        &#34;&#34;&#34; Get the list of older directories &#34;&#34;&#34;
        older = []
        # Parse all directories in sdcard
        for fileinfo in uos.ilistdir(useful.SdCard.getMountpoint()):
                filename = fileinfo[0]
                typ = fileinfo[1]
                # If directory found
                if typ &amp; 0xF000 == 0x4000:
                        # If motion directory recognized
                        if  (filename[4] == &#34;-&#34; and filename[7] == &#34;-&#34; and len(filename) == 10) or \
                                (filename[4] == &#34;-&#34; and filename[7] == &#34;-&#34; and (filename[10] == &#34;_&#34; or filename[10] == &#34; &#34;) and filename[13] == &#34;-&#34; and (len(filename) == 16 or len(filename) == 19)):
                                # Add directory to the list
                                older.append(filename)
                                if len(older) &gt; (quantity + 10):
                                        older.sort()
                                        older = older[:quantity]
        older.sort()
        older = older[:quantity]
        return older</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.removeFiles"><code class="name flex">
<span>def <span class="ident">removeFiles</span></span>(<span>directory, simulate=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Remove all files in the directory</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def removeFiles(directory, simulate=False):
        &#34;&#34;&#34; Remove all files in the directory &#34;&#34;&#34;
        import shell
        notEmpty = False
        # Parse all directories in sdcard
        for fileinfo in uos.ilistdir(directory):
                filename = fileinfo[0]
                typ      = fileinfo[1]
                # If file found
                if typ &amp; 0xF000 != 0x4000:
                        shell.rmfile(directory + &#34;/&#34; + filename, simulate=simulate)
                else:
                        removeFiles(directory + &#34;/&#34; + filename)
                        notEmpty = True
        
        if notEmpty:
                shell.rm(directory, recursive=True, simulate=simulate)
        else:
                shell.rmdir(directory, recursive=True, simulate=simulate)</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.removeOlder"><code class="name flex">
<span>async def <span class="ident">removeOlder</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Remove older files to make space</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def removeOlder():
        &#34;&#34;&#34; Remove older files to make space &#34;&#34;&#34;
        while 1:
                await sleep_ms(100000)
                await server.waitResume()
                if useful.SdCard.isMounted():
                        # If not enough space available on sdcard
                        if useful.SdCard.getFreeSize() * 10000// useful.SdCard.getMaxSize() &lt;= 5:
                                olders = getOlderDirectories(useful.SdCard.getMountpoint())
                                for directory in olders:
                                        removeFiles(useful.SdCard.getMountpoint()+ &#34;/&#34;+ directory)</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.sleep_ms"><code class="name flex">
<span>async def <span class="ident">sleep_ms</span></span>(<span>duration)</span>
</code></dt>
<dd>
<div class="desc"><p>Multiplatform sleep_ms</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def sleep_ms(duration):
        &#34;&#34;&#34; Multiplatform sleep_ms &#34;&#34;&#34;
        await uasyncio.sleep_ms(duration)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="lib.motion.motion.ImageMotion"><code class="flex name class">
<span>class <span class="ident">ImageMotion</span></span>
<span>(</span><span>motion, config)</span>
</code></dt>
<dd>
<div class="desc"><p>Class managing a motion detection image</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ImageMotion:
        &#34;&#34;&#34; Class managing a motion detection image &#34;&#34;&#34;
        baseIndex = [0]
        motionBaseId = [0]
        def __init__(self, motion, config):
                self.motion = motion
                self.baseIndex[0] += 1
                self.index    = self.baseIndex[0]
                self.filename = None
                self.diffSaturation = 0
                self.diffLight = 0
                self.diffHue  = 0
                self.notified = False
                self.motionId = None
                self.date     = useful.dateToFilename()
                self.path     = useful.dateToFilename()[:-3]+&#34;-00&#34;
                self.motionDetected = False
                self.config = config

        def deinit(self):
                &#34;&#34;&#34; Destructor &#34;&#34;&#34;
                self.motion.deinit()
        
        def setMotionId(self, motionId = None):
                &#34;&#34;&#34; Set the unique image identifier &#34;&#34;&#34;
                if motionId == None:
                        self.motionBaseId[0] += 1
                        self.motionId = self.motionBaseId[0]
                else:
                        if self.motionId == None:
                                self.motionId = motionId
                        else:
                                print(&#34;Motion id already set&#34;)
        
        def getMotionId(self):
                &#34;&#34;&#34; Get the unique image identifier &#34;&#34;&#34;
                return self.motionId

        def getFilename(self):
                &#34;&#34;&#34; Get the storage filename &#34;&#34;&#34;
                return &#34;%s id=%d S=%d L=%d.jpg&#34;%(self.date, self.index, self.diffSaturation, self.diffLight)

        def save(self):
                &#34;&#34;&#34; Save the image on sd card &#34;&#34;&#34;
                if useful.SdCard.isMounted():
                        useful.makedir(useful.SdCard.getMountpoint() + &#34;/&#34; + self.path, True)
                        useful.SdCard.save(self.path + &#34;/&#34; + self.getFilename(), self.motion.getImage())

        def compare(self, previous, set=False):
                &#34;&#34;&#34; Compare two motion images to get differences &#34;&#34;&#34;
                self.motion.setErrorLight(self.config.lightErrorRange)
                self.motion.setErrorSaturation(self.config.saturationErrorRange)
                res = self.motion.compare(previous.motion)
                if set:
                        self.diffHue, self.diffSaturation, self.diffLight  = res[0],res[1],res[2]
                return (res[0],res[1],res[2])

        def getMotionDetected(self):
                &#34;&#34;&#34; Get the motion detection status &#34;&#34;&#34;
                return self.motionDetected
        
        def setMotionDetected(self):
                &#34;&#34;&#34; Set the motion detection status &#34;&#34;&#34;
                self.motionDetected = True
        
        def get(self):
                &#34;&#34;&#34; Get the image captured &#34;&#34;&#34;
                return self.motion.getImage()
        
        def getDiffHue(self):
                &#34;&#34;&#34; Get the hue difference &#34;&#34;&#34;
                return self.diffHue

        def getDiffSaturation(self):
                &#34;&#34;&#34; Get the saturation difference &#34;&#34;&#34;
                return self.diffSaturation

        def getDiffLight(self):
                &#34;&#34;&#34; Get the light difference &#34;&#34;&#34;
                return self.diffLight

        def getFeature(self):
                &#34;&#34;&#34; Return mean, min, max light, mean, min, max, saturation, total count &#34;&#34;&#34;
                return self.motion.getFeature()

        def resetDifferences(self):
                &#34;&#34;&#34; Reset the differences, used during the camera stabilization image &#34;&#34;&#34;
                self.diffSaturation = 0
                self.diffLight = 0</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="lib.motion.motion.ImageMotion.baseIndex"><code class="name">var <span class="ident">baseIndex</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="lib.motion.motion.ImageMotion.motionBaseId"><code class="name">var <span class="ident">motionBaseId</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="lib.motion.motion.ImageMotion.compare"><code class="name flex">
<span>def <span class="ident">compare</span></span>(<span>self, previous, set=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Compare two motion images to get differences</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def compare(self, previous, set=False):
        &#34;&#34;&#34; Compare two motion images to get differences &#34;&#34;&#34;
        self.motion.setErrorLight(self.config.lightErrorRange)
        self.motion.setErrorSaturation(self.config.saturationErrorRange)
        res = self.motion.compare(previous.motion)
        if set:
                self.diffHue, self.diffSaturation, self.diffLight  = res[0],res[1],res[2]
        return (res[0],res[1],res[2])</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.deinit"><code class="name flex">
<span>def <span class="ident">deinit</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Destructor</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deinit(self):
        &#34;&#34;&#34; Destructor &#34;&#34;&#34;
        self.motion.deinit()</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.get"><code class="name flex">
<span>def <span class="ident">get</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the image captured</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get(self):
        &#34;&#34;&#34; Get the image captured &#34;&#34;&#34;
        return self.motion.getImage()</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getDiffHue"><code class="name flex">
<span>def <span class="ident">getDiffHue</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the hue difference</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getDiffHue(self):
        &#34;&#34;&#34; Get the hue difference &#34;&#34;&#34;
        return self.diffHue</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getDiffLight"><code class="name flex">
<span>def <span class="ident">getDiffLight</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the light difference</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getDiffLight(self):
        &#34;&#34;&#34; Get the light difference &#34;&#34;&#34;
        return self.diffLight</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getDiffSaturation"><code class="name flex">
<span>def <span class="ident">getDiffSaturation</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the saturation difference</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getDiffSaturation(self):
        &#34;&#34;&#34; Get the saturation difference &#34;&#34;&#34;
        return self.diffSaturation</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getFeature"><code class="name flex">
<span>def <span class="ident">getFeature</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Return mean, min, max light, mean, min, max, saturation, total count</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getFeature(self):
        &#34;&#34;&#34; Return mean, min, max light, mean, min, max, saturation, total count &#34;&#34;&#34;
        return self.motion.getFeature()</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getFilename"><code class="name flex">
<span>def <span class="ident">getFilename</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the storage filename</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getFilename(self):
        &#34;&#34;&#34; Get the storage filename &#34;&#34;&#34;
        return &#34;%s id=%d S=%d L=%d.jpg&#34;%(self.date, self.index, self.diffSaturation, self.diffLight)</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getMotionDetected"><code class="name flex">
<span>def <span class="ident">getMotionDetected</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the motion detection status</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getMotionDetected(self):
        &#34;&#34;&#34; Get the motion detection status &#34;&#34;&#34;
        return self.motionDetected</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.getMotionId"><code class="name flex">
<span>def <span class="ident">getMotionId</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the unique image identifier</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getMotionId(self):
        &#34;&#34;&#34; Get the unique image identifier &#34;&#34;&#34;
        return self.motionId</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.resetDifferences"><code class="name flex">
<span>def <span class="ident">resetDifferences</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Reset the differences, used during the camera stabilization image</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def resetDifferences(self):
        &#34;&#34;&#34; Reset the differences, used during the camera stabilization image &#34;&#34;&#34;
        self.diffSaturation = 0
        self.diffLight = 0</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.save"><code class="name flex">
<span>def <span class="ident">save</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Save the image on sd card</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def save(self):
        &#34;&#34;&#34; Save the image on sd card &#34;&#34;&#34;
        if useful.SdCard.isMounted():
                useful.makedir(useful.SdCard.getMountpoint() + &#34;/&#34; + self.path, True)
                useful.SdCard.save(self.path + &#34;/&#34; + self.getFilename(), self.motion.getImage())</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.setMotionDetected"><code class="name flex">
<span>def <span class="ident">setMotionDetected</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Set the motion detection status</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def setMotionDetected(self):
        &#34;&#34;&#34; Set the motion detection status &#34;&#34;&#34;
        self.motionDetected = True</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.ImageMotion.setMotionId"><code class="name flex">
<span>def <span class="ident">setMotionId</span></span>(<span>self, motionId=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Set the unique image identifier</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def setMotionId(self, motionId = None):
        &#34;&#34;&#34; Set the unique image identifier &#34;&#34;&#34;
        if motionId == None:
                self.motionBaseId[0] += 1
                self.motionId = self.motionBaseId[0]
        else:
                if self.motionId == None:
                        self.motionId = motionId
                else:
                        print(&#34;Motion id already set&#34;)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="lib.motion.motion.Motion"><code class="flex name class">
<span>class <span class="ident">Motion</span></span>
<span>(</span><span>config=None, onBattery=False, pirDetection=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Class to manage the motion capture</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Motion:
        &#34;&#34;&#34; Class to manage the motion capture &#34;&#34;&#34;
        def __init__(self, config= None, onBattery=False, pirDetection=False):
                self.images = []
                self.index  = 0
                self.config = config
                self.onBattery = onBattery
                self.pirDetection = pirDetection

        def open(self):
                &#34;&#34;&#34; Open camera &#34;&#34;&#34;
                print(&#34;Open camera&#34;)
                video.Camera.open()
                self.resume()

        def resume(self):
                &#34;&#34;&#34; Resume the camera, restore the camera configuration after an interruption &#34;&#34;&#34;
                # video.Camera.framesize(b&#34;UXGA&#34;) # 1600x1200
                # video.Camera.framesize(b&#34;SXGA&#34;) # 1280x1024
                # video.Camera.framesize(b&#34;XGA&#34;)  # 1024x768
                video.Camera.framesize(b&#34;SVGA&#34;) # 800x600

                video.Camera.pixformat(b&#34;JPEG&#34;)
                video.Camera.quality(10)
                video.Camera.brightness(0)
                video.Camera.contrast(0)
                video.Camera.saturation(0)
                video.Camera.hmirror(0)
                video.Camera.vflip(0)

        def capture(self):
                &#34;&#34;&#34; Capture motion image &#34;&#34;&#34;
                result = None
                retry = 10
                if len(self.images) &gt;= self.config.maxMotionImages:
                        image = self.images.pop()
                        
                        # If motion detected on image, on battery the first five images are sent
                        if image.getMotionDetected() or (self.onBattery and self.pirDetection and image.index &lt;= 3):
                                # Notification of motion
                                result = (&#34;Intrusion %s&#34;%image.getFilename(), image)

                                # Save image to sdcard
                                image.save()
                        else:
                                image.deinit()
                while 1:
                        if retry == 0:
                                print(&#34;Reset&#34;)
                                machine.reset()

                        try:
                                image = ImageMotion(video.Camera.motion(), self.config)
                                self.images.insert(0, image)
                                self.index += 1
                                break
                        except ValueError:
                                print(&#34;Failed to get motion %d try before reset&#34;%retry)
                                retry += 1
                                time.sleep(0.5)
                return result

        def isStabilized(self):
                &#34;&#34;&#34; Indicates if the camera is stabilized &#34;&#34;&#34;
                # If the PIR detection force the stabilization
                if self.pirDetection == True:
                        stabilized = True
                # If the camera not stabilized
                elif len(self.images) &lt; self.config.stabilizationCamera:
                        stabilized = False
                else:
                        stabilized = True
                return stabilized

        def compare(self):
                &#34;&#34;&#34; Compare all images captured and search differences &#34;&#34;&#34;
                differences = {}
                if len(self.images) &gt;= 2:
                        current = self.images[0]
                        
                        # Compute the motion identifier
                        for previous in self.images[1:]:
                                hue, saturation, light = current.compare(previous, True)

                                # If camera not stabilized
                                if self.isStabilized() == False:
                                        # Reject the differences
                                        current.resetDifferences()
                                        break
                                # If image seem equal to previous
                                if saturation &lt;= self.config.saturationDetection and \
                                   light      &lt;= self.config.lightDetection:
                                        # Reuse the motion identifier
                                        current.setMotionId(previous.motionId)
                                        break
                        else:
                                # Create new motion id
                                current.setMotionId()

                        # Compute the list of differences
                        diffs = &#34;&#34;
                        for image in self.images:
                                differences.setdefault(image.getMotionId(), []).append(image.getMotionId())
                                if image.getMotionId() != None:
                                        diffs += &#34; %d:%d,%d&#34;%(image.getMotionId(), image.getDiffSaturation(), image.getDiffLight())
                        sys.stdout.write(&#34;\r%s %s    &#34;%(useful.dateToString()[12:], diffs))
                return differences

        def detect(self):
                &#34;&#34;&#34; Detect motion &#34;&#34;&#34;
                detected = False
                changePolling = False

                # Compute the list of differences
                differences = self.compare()

                # Too many differences found
                if len(list(differences.keys())) &gt;= self.config.thresholdMotion:
                        detected = True
                        changePolling = True
                # If no differences
                elif len(list(differences.keys())) == 1:
                        detected = False
                # If not enough differences
                elif len(list(differences.keys())) &lt;= self.config.thresholdGlitch:
                        detected = True
                        changePolling = True
                        # Check if it is a glitch
                        for diff in differences.values():
                                if len(diff) &lt;= 1:
                                        print(&#34;%s Glitch (S=%d,L=%d)    &#34;%(useful.dateToString()[12:], self.images[0].getDiffSaturation(), self.images[0].getDiffLight()))
                                        # Glitch ignored
                                        detected = False
                                        break
                # Not detected
                else:
                        detected = False

                if detected:
                        # Mark all motion images
                        for image in self.images:
                                diffSaturation = image.getDiffSaturation()
                                diffLight      = image.getDiffLight()
                                
                                # If image seem equal to previous
                                if  diffSaturation &gt; self.config.saturationDetection and \
                                    diffLight      &gt; self.config.lightDetection:
                                        image.setMotionDetected()
                return detected, changePolling</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="lib.motion.motion.Motion.capture"><code class="name flex">
<span>def <span class="ident">capture</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Capture motion image</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def capture(self):
        &#34;&#34;&#34; Capture motion image &#34;&#34;&#34;
        result = None
        retry = 10
        if len(self.images) &gt;= self.config.maxMotionImages:
                image = self.images.pop()
                
                # If motion detected on image, on battery the first five images are sent
                if image.getMotionDetected() or (self.onBattery and self.pirDetection and image.index &lt;= 3):
                        # Notification of motion
                        result = (&#34;Intrusion %s&#34;%image.getFilename(), image)

                        # Save image to sdcard
                        image.save()
                else:
                        image.deinit()
        while 1:
                if retry == 0:
                        print(&#34;Reset&#34;)
                        machine.reset()

                try:
                        image = ImageMotion(video.Camera.motion(), self.config)
                        self.images.insert(0, image)
                        self.index += 1
                        break
                except ValueError:
                        print(&#34;Failed to get motion %d try before reset&#34;%retry)
                        retry += 1
                        time.sleep(0.5)
        return result</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.Motion.compare"><code class="name flex">
<span>def <span class="ident">compare</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Compare all images captured and search differences</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def compare(self):
        &#34;&#34;&#34; Compare all images captured and search differences &#34;&#34;&#34;
        differences = {}
        if len(self.images) &gt;= 2:
                current = self.images[0]
                
                # Compute the motion identifier
                for previous in self.images[1:]:
                        hue, saturation, light = current.compare(previous, True)

                        # If camera not stabilized
                        if self.isStabilized() == False:
                                # Reject the differences
                                current.resetDifferences()
                                break
                        # If image seem equal to previous
                        if saturation &lt;= self.config.saturationDetection and \
                           light      &lt;= self.config.lightDetection:
                                # Reuse the motion identifier
                                current.setMotionId(previous.motionId)
                                break
                else:
                        # Create new motion id
                        current.setMotionId()

                # Compute the list of differences
                diffs = &#34;&#34;
                for image in self.images:
                        differences.setdefault(image.getMotionId(), []).append(image.getMotionId())
                        if image.getMotionId() != None:
                                diffs += &#34; %d:%d,%d&#34;%(image.getMotionId(), image.getDiffSaturation(), image.getDiffLight())
                sys.stdout.write(&#34;\r%s %s    &#34;%(useful.dateToString()[12:], diffs))
        return differences</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.Motion.detect"><code class="name flex">
<span>def <span class="ident">detect</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Detect motion</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def detect(self):
        &#34;&#34;&#34; Detect motion &#34;&#34;&#34;
        detected = False
        changePolling = False

        # Compute the list of differences
        differences = self.compare()

        # Too many differences found
        if len(list(differences.keys())) &gt;= self.config.thresholdMotion:
                detected = True
                changePolling = True
        # If no differences
        elif len(list(differences.keys())) == 1:
                detected = False
        # If not enough differences
        elif len(list(differences.keys())) &lt;= self.config.thresholdGlitch:
                detected = True
                changePolling = True
                # Check if it is a glitch
                for diff in differences.values():
                        if len(diff) &lt;= 1:
                                print(&#34;%s Glitch (S=%d,L=%d)    &#34;%(useful.dateToString()[12:], self.images[0].getDiffSaturation(), self.images[0].getDiffLight()))
                                # Glitch ignored
                                detected = False
                                break
        # Not detected
        else:
                detected = False

        if detected:
                # Mark all motion images
                for image in self.images:
                        diffSaturation = image.getDiffSaturation()
                        diffLight      = image.getDiffLight()
                        
                        # If image seem equal to previous
                        if  diffSaturation &gt; self.config.saturationDetection and \
                            diffLight      &gt; self.config.lightDetection:
                                image.setMotionDetected()
        return detected, changePolling</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.Motion.isStabilized"><code class="name flex">
<span>def <span class="ident">isStabilized</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Indicates if the camera is stabilized</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def isStabilized(self):
        &#34;&#34;&#34; Indicates if the camera is stabilized &#34;&#34;&#34;
        # If the PIR detection force the stabilization
        if self.pirDetection == True:
                stabilized = True
        # If the camera not stabilized
        elif len(self.images) &lt; self.config.stabilizationCamera:
                stabilized = False
        else:
                stabilized = True
        return stabilized</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.Motion.open"><code class="name flex">
<span>def <span class="ident">open</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Open camera</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def open(self):
        &#34;&#34;&#34; Open camera &#34;&#34;&#34;
        print(&#34;Open camera&#34;)
        video.Camera.open()
        self.resume()</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.Motion.resume"><code class="name flex">
<span>def <span class="ident">resume</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Resume the camera, restore the camera configuration after an interruption</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def resume(self):
        &#34;&#34;&#34; Resume the camera, restore the camera configuration after an interruption &#34;&#34;&#34;
        # video.Camera.framesize(b&#34;UXGA&#34;) # 1600x1200
        # video.Camera.framesize(b&#34;SXGA&#34;) # 1280x1024
        # video.Camera.framesize(b&#34;XGA&#34;)  # 1024x768
        video.Camera.framesize(b&#34;SVGA&#34;) # 800x600

        video.Camera.pixformat(b&#34;JPEG&#34;)
        video.Camera.quality(10)
        video.Camera.brightness(0)
        video.Camera.contrast(0)
        video.Camera.saturation(0)
        video.Camera.hmirror(0)
        video.Camera.vflip(0)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="lib.motion.motion.MotionConfig"><code class="flex name class">
<span>class <span class="ident">MotionConfig</span></span>
</code></dt>
<dd>
<div class="desc"><p>Configuration class of motion detection</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class MotionConfig:
        &#34;&#34;&#34; Configuration class of motion detection &#34;&#34;&#34;
        def __init__(self):
                # Indicates if the motion is activated
                self.activated = False

                # Suspend the motion detection when presence detected
                self.suspendOnPresence = True

                # Minimum threshold detection for saturation
                self.saturationDetection=10
  
                # Minimum threshold detection for light
                self.lightDetection=10

                # Awake time on battery (seconds)
                self.awakeTime = 120

                # Error range ignore light modification
                self.lightErrorRange=5

                # Error range ignore saturation modification
                self.saturationErrorRange=5
  
                # Max images in motion historic
                self.maxMotionImages=10

                # Glitch threshold of image ignored (sometime the camera bug)
                self.thresholdGlitch=2

                # Threshold of minimum image to detect motion
                self.thresholdMotion=3

                # Number of images before camera stabilization
                self.stabilizationCamera=6

        def save(self, file = None):
                &#34;&#34;&#34; Save configuration &#34;&#34;&#34;
                result = jsonconfig.save(self, file)
                return result

        def update(self, params):
                &#34;&#34;&#34; Update configuration &#34;&#34;&#34;
                result = jsonconfig.update(self, params)
                return result

        def load(self, file = None):
                &#34;&#34;&#34; Load configuration &#34;&#34;&#34;
                result = jsonconfig.load(self, file)
                return result</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="lib.motion.motion.MotionConfig.load"><code class="name flex">
<span>def <span class="ident">load</span></span>(<span>self, file=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Load configuration</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load(self, file = None):
        &#34;&#34;&#34; Load configuration &#34;&#34;&#34;
        result = jsonconfig.load(self, file)
        return result</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.MotionConfig.save"><code class="name flex">
<span>def <span class="ident">save</span></span>(<span>self, file=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Save configuration</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def save(self, file = None):
        &#34;&#34;&#34; Save configuration &#34;&#34;&#34;
        result = jsonconfig.save(self, file)
        return result</code></pre>
</details>
</dd>
<dt id="lib.motion.motion.MotionConfig.update"><code class="name flex">
<span>def <span class="ident">update</span></span>(<span>self, params)</span>
</code></dt>
<dd>
<div class="desc"><p>Update configuration</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def update(self, params):
        &#34;&#34;&#34; Update configuration &#34;&#34;&#34;
        result = jsonconfig.update(self, params)
        return result</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="lib.motion" href="index.html">lib.motion</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="lib.motion.motion.detectMotion" href="#lib.motion.motion.detectMotion">detectMotion</a></code></li>
<li><code><a title="lib.motion.motion.getOlderDirectories" href="#lib.motion.motion.getOlderDirectories">getOlderDirectories</a></code></li>
<li><code><a title="lib.motion.motion.removeFiles" href="#lib.motion.motion.removeFiles">removeFiles</a></code></li>
<li><code><a title="lib.motion.motion.removeOlder" href="#lib.motion.motion.removeOlder">removeOlder</a></code></li>
<li><code><a title="lib.motion.motion.sleep_ms" href="#lib.motion.motion.sleep_ms">sleep_ms</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="lib.motion.motion.ImageMotion" href="#lib.motion.motion.ImageMotion">ImageMotion</a></code></h4>
<ul class="two-column">
<li><code><a title="lib.motion.motion.ImageMotion.baseIndex" href="#lib.motion.motion.ImageMotion.baseIndex">baseIndex</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.compare" href="#lib.motion.motion.ImageMotion.compare">compare</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.deinit" href="#lib.motion.motion.ImageMotion.deinit">deinit</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.get" href="#lib.motion.motion.ImageMotion.get">get</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getDiffHue" href="#lib.motion.motion.ImageMotion.getDiffHue">getDiffHue</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getDiffLight" href="#lib.motion.motion.ImageMotion.getDiffLight">getDiffLight</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getDiffSaturation" href="#lib.motion.motion.ImageMotion.getDiffSaturation">getDiffSaturation</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getFeature" href="#lib.motion.motion.ImageMotion.getFeature">getFeature</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getFilename" href="#lib.motion.motion.ImageMotion.getFilename">getFilename</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getMotionDetected" href="#lib.motion.motion.ImageMotion.getMotionDetected">getMotionDetected</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.getMotionId" href="#lib.motion.motion.ImageMotion.getMotionId">getMotionId</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.motionBaseId" href="#lib.motion.motion.ImageMotion.motionBaseId">motionBaseId</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.resetDifferences" href="#lib.motion.motion.ImageMotion.resetDifferences">resetDifferences</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.save" href="#lib.motion.motion.ImageMotion.save">save</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.setMotionDetected" href="#lib.motion.motion.ImageMotion.setMotionDetected">setMotionDetected</a></code></li>
<li><code><a title="lib.motion.motion.ImageMotion.setMotionId" href="#lib.motion.motion.ImageMotion.setMotionId">setMotionId</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="lib.motion.motion.Motion" href="#lib.motion.motion.Motion">Motion</a></code></h4>
<ul class="two-column">
<li><code><a title="lib.motion.motion.Motion.capture" href="#lib.motion.motion.Motion.capture">capture</a></code></li>
<li><code><a title="lib.motion.motion.Motion.compare" href="#lib.motion.motion.Motion.compare">compare</a></code></li>
<li><code><a title="lib.motion.motion.Motion.detect" href="#lib.motion.motion.Motion.detect">detect</a></code></li>
<li><code><a title="lib.motion.motion.Motion.isStabilized" href="#lib.motion.motion.Motion.isStabilized">isStabilized</a></code></li>
<li><code><a title="lib.motion.motion.Motion.open" href="#lib.motion.motion.Motion.open">open</a></code></li>
<li><code><a title="lib.motion.motion.Motion.resume" href="#lib.motion.motion.Motion.resume">resume</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="lib.motion.motion.MotionConfig" href="#lib.motion.motion.MotionConfig">MotionConfig</a></code></h4>
<ul class="">
<li><code><a title="lib.motion.motion.MotionConfig.load" href="#lib.motion.motion.MotionConfig.load">load</a></code></li>
<li><code><a title="lib.motion.motion.MotionConfig.save" href="#lib.motion.motion.MotionConfig.save">save</a></code></li>
<li><code><a title="lib.motion.motion.MotionConfig.update" href="#lib.motion.motion.MotionConfig.update">update</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>